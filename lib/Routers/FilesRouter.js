"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FilesRouter = void 0;

var _express = _interopRequireDefault(require("express"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var Middlewares = _interopRequireWildcard(require("../middlewares"));

var _node = _interopRequireDefault(require("parse/node"));

var _Config = _interopRequireDefault(require("../Config"));

var _mime = _interopRequireDefault(require("mime"));

var _logger = _interopRequireDefault(require("../logger"));

var _FunctionsRouter = require("./FunctionsRouter");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const triggers = require('../triggers');

const http = require('http');

const downloadFileFromURI = uri => {
  return new Promise((res, rej) => {
    http.get(uri, response => {
      response.setDefaultEncoding('base64');
      let body = `data:${response.headers['content-type']};base64,`;
      response.on('data', data => body += data);
      response.on('end', () => res(body));
    }).on('error', e => {
      rej(`Error downloading file from ${uri}: ${e.message}`);
    });
  });
};

const addFileDataIfNeeded = async file => {
  if (file._source.format === 'uri') {
    const base64 = await downloadFileFromURI(file._source.uri);
    file._previousSave = file;
    file._data = base64;
    file._requestTask = null;
  }

  return file;
};

class FilesRouter {
  expressRouter({
    maxUploadSize = '20Mb'
  } = {}) {
    var router = _express.default.Router();

    router.get('/files/:appId/:filename', this.getHandler);
    router.get('/files/:appId/metadata/:filename', this.metadataHandler);
    router.post('/files', function (req, res, next) {
      next(new _node.default.Error(_node.default.Error.INVALID_FILE_NAME, 'Filename not provided.'));
    });
    router.post('/files/:filename', _bodyParser.default.raw({
      type: () => {
        return true;
      },
      limit: maxUploadSize
    }), // Allow uploads without Content-Type, or with any Content-Type.
    Middlewares.handleParseHeaders, this.createHandler);
    router.delete('/files/:filename', Middlewares.handleParseHeaders, Middlewares.enforceMasterKeyAccess, this.deleteHandler);
    router.post('/files/:filename/:functionName', _bodyParser.default.raw({
      type: () => {
        return true;
      },
      limit: maxUploadSize
    }), // Allow uploads without Content-Type, or with any Content-Type.
    Middlewares.handleParseHeaders, req => {
      req.params.className = '@File';
      return _FunctionsRouter.FunctionsRouter.handleCloudFunction(req);
    });
    return router;
  }

  getHandler(req, res) {
    const config = _Config.default.get(req.params.appId);

    if (!config) {
      res.status(403);
      const err = new _node.default.Error(_node.default.Error.OPERATION_FORBIDDEN, 'Invalid application ID.');
      res.json({
        code: err.code,
        error: err.message
      });
      return;
    }

    const filesController = config.filesController;
    const filename = req.params.filename;

    const contentType = _mime.default.getType(filename);

    if (isFileStreamable(req, filesController)) {
      filesController.handleFileStream(config, filename, req, res, contentType).catch(() => {
        res.status(404);
        res.set('Content-Type', 'text/plain');
        res.end('File not found.');
      });
    } else {
      filesController.getFileData(config, filename).then(data => {
        res.status(200);
        res.set('Content-Type', contentType);
        res.set('Content-Length', data.length);
        res.end(data);
      }).catch(() => {
        res.status(404);
        res.set('Content-Type', 'text/plain');
        res.end('File not found.');
      });
    }
  }

  async createHandler(req, res, next) {
    const config = req.config;
    const user = req.auth.user;
    const isMaster = req.auth.isMaster;

    const isLinked = user && _node.default.AnonymousUtils.isLinked(user);

    if (!isMaster && !config.fileUpload.enableForAnonymousUser && isLinked) {
      next(new _node.default.Error(_node.default.Error.FILE_SAVE_ERROR, 'File upload by anonymous user is disabled.'));
      return;
    }

    if (!isMaster && !config.fileUpload.enableForAuthenticatedUser && !isLinked && user) {
      next(new _node.default.Error(_node.default.Error.FILE_SAVE_ERROR, 'File upload by authenticated user is disabled.'));
      return;
    }

    if (!isMaster && !config.fileUpload.enableForPublic && !user) {
      next(new _node.default.Error(_node.default.Error.FILE_SAVE_ERROR, 'File upload by public is disabled.'));
      return;
    }

    const filesController = config.filesController;
    const {
      filename
    } = req.params;
    const contentType = req.get('Content-type');

    if (!req.body || !req.body.length) {
      next(new _node.default.Error(_node.default.Error.FILE_SAVE_ERROR, 'Invalid file upload.'));
      return;
    }

    const error = filesController.validateFilename(filename);

    if (error) {
      next(error);
      return;
    }

    const base64 = req.body.toString('base64');
    const file = new _node.default.File(filename, {
      base64
    }, contentType);
    const {
      metadata = {},
      tags = {}
    } = req.fileData || {};
    file.setTags(tags);
    file.setMetadata(metadata);
    const fileSize = Buffer.byteLength(req.body);
    const fileObject = {
      file,
      fileSize
    };

    try {
      // run beforeSaveFile trigger
      const triggerResult = await triggers.maybeRunFileTrigger(triggers.Types.beforeSaveFile, fileObject, config, req.auth);
      let saveResult; // if a new ParseFile is returned check if it's an already saved file

      if (triggerResult instanceof _node.default.File) {
        fileObject.file = triggerResult;

        if (triggerResult.url()) {
          // set fileSize to null because we wont know how big it is here
          fileObject.fileSize = null;
          saveResult = {
            url: triggerResult.url(),
            name: triggerResult._name
          };
        }
      } // if the file returned by the trigger has already been saved skip saving anything


      if (!saveResult) {
        // if the ParseFile returned is type uri, download the file before saving it
        await addFileDataIfNeeded(fileObject.file); // update fileSize

        const bufferData = Buffer.from(fileObject.file._data, 'base64');
        fileObject.fileSize = Buffer.byteLength(bufferData); // prepare file options

        const fileOptions = {
          metadata: fileObject.file._metadata
        }; // some s3-compatible providers (DigitalOcean, Linode) do not accept tags
        // so we do not include the tags option if it is empty.

        const fileTags = Object.keys(fileObject.file._tags).length > 0 ? {
          tags: fileObject.file._tags
        } : {};
        Object.assign(fileOptions, fileTags); // save file

        const createFileResult = await filesController.createFile(config, fileObject.file._name, bufferData, fileObject.file._source.type, fileOptions); // update file with new data

        fileObject.file._name = createFileResult.name;
        fileObject.file._url = createFileResult.url;
        fileObject.file._requestTask = null;
        fileObject.file._previousSave = Promise.resolve(fileObject.file);
        saveResult = {
          url: createFileResult.url,
          name: createFileResult.name
        };
      } // run afterSaveFile trigger


      await triggers.maybeRunFileTrigger(triggers.Types.afterSaveFile, fileObject, config, req.auth);
      res.status(201);
      res.set('Location', saveResult.url);
      res.json(saveResult);
    } catch (e) {
      _logger.default.error('Error creating a file: ', e);

      const error = triggers.resolveError(e, {
        code: _node.default.Error.FILE_SAVE_ERROR,
        message: `Could not store file: ${fileObject.file._name}.`
      });
      next(error);
    }
  }

  async deleteHandler(req, res, next) {
    try {
      const {
        filesController
      } = req.config;
      const {
        filename
      } = req.params; // run beforeDeleteFile trigger

      const file = new _node.default.File(filename);
      file._url = filesController.adapter.getFileLocation(req.config, filename);
      const fileObject = {
        file,
        fileSize: null
      };
      await triggers.maybeRunFileTrigger(triggers.Types.beforeDeleteFile, fileObject, req.config, req.auth); // delete file

      await filesController.deleteFile(req.config, filename); // run afterDeleteFile trigger

      await triggers.maybeRunFileTrigger(triggers.Types.afterDeleteFile, fileObject, req.config, req.auth);
      res.status(200); // TODO: return useful JSON here?

      res.end();
    } catch (e) {
      _logger.default.error('Error deleting a file: ', e);

      const error = triggers.resolveError(e, {
        code: _node.default.Error.FILE_DELETE_ERROR,
        message: 'Could not delete file.'
      });
      next(error);
    }
  }

  async metadataHandler(req, res) {
    try {
      const config = _Config.default.get(req.params.appId);

      const {
        filesController
      } = config;
      const {
        filename
      } = req.params;
      const data = await filesController.getMetadata(filename);
      res.status(200);
      res.json(data);
    } catch (e) {
      res.status(200);
      res.json({});
    }
  }

}

exports.FilesRouter = FilesRouter;

function isFileStreamable(req, filesController) {
  return req.get('Range') && typeof filesController.adapter.handleFileStream === 'function';
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJ0cmlnZ2VycyIsInJlcXVpcmUiLCJodHRwIiwiZG93bmxvYWRGaWxlRnJvbVVSSSIsInVyaSIsIlByb21pc2UiLCJyZXMiLCJyZWoiLCJnZXQiLCJyZXNwb25zZSIsInNldERlZmF1bHRFbmNvZGluZyIsImJvZHkiLCJoZWFkZXJzIiwib24iLCJkYXRhIiwiZSIsIm1lc3NhZ2UiLCJhZGRGaWxlRGF0YUlmTmVlZGVkIiwiZmlsZSIsIl9zb3VyY2UiLCJmb3JtYXQiLCJiYXNlNjQiLCJfcHJldmlvdXNTYXZlIiwiX2RhdGEiLCJfcmVxdWVzdFRhc2siLCJGaWxlc1JvdXRlciIsImV4cHJlc3NSb3V0ZXIiLCJtYXhVcGxvYWRTaXplIiwicm91dGVyIiwiZXhwcmVzcyIsIlJvdXRlciIsImdldEhhbmRsZXIiLCJtZXRhZGF0YUhhbmRsZXIiLCJwb3N0IiwicmVxIiwibmV4dCIsIlBhcnNlIiwiRXJyb3IiLCJJTlZBTElEX0ZJTEVfTkFNRSIsIkJvZHlQYXJzZXIiLCJyYXciLCJ0eXBlIiwibGltaXQiLCJNaWRkbGV3YXJlcyIsImhhbmRsZVBhcnNlSGVhZGVycyIsImNyZWF0ZUhhbmRsZXIiLCJkZWxldGUiLCJlbmZvcmNlTWFzdGVyS2V5QWNjZXNzIiwiZGVsZXRlSGFuZGxlciIsInBhcmFtcyIsImNsYXNzTmFtZSIsIkZ1bmN0aW9uc1JvdXRlciIsImhhbmRsZUNsb3VkRnVuY3Rpb24iLCJjb25maWciLCJDb25maWciLCJhcHBJZCIsInN0YXR1cyIsImVyciIsIk9QRVJBVElPTl9GT1JCSURERU4iLCJqc29uIiwiY29kZSIsImVycm9yIiwiZmlsZXNDb250cm9sbGVyIiwiZmlsZW5hbWUiLCJjb250ZW50VHlwZSIsIm1pbWUiLCJnZXRUeXBlIiwiaXNGaWxlU3RyZWFtYWJsZSIsImhhbmRsZUZpbGVTdHJlYW0iLCJjYXRjaCIsInNldCIsImVuZCIsImdldEZpbGVEYXRhIiwidGhlbiIsImxlbmd0aCIsInVzZXIiLCJhdXRoIiwiaXNNYXN0ZXIiLCJpc0xpbmtlZCIsIkFub255bW91c1V0aWxzIiwiZmlsZVVwbG9hZCIsImVuYWJsZUZvckFub255bW91c1VzZXIiLCJGSUxFX1NBVkVfRVJST1IiLCJlbmFibGVGb3JBdXRoZW50aWNhdGVkVXNlciIsImVuYWJsZUZvclB1YmxpYyIsInZhbGlkYXRlRmlsZW5hbWUiLCJ0b1N0cmluZyIsIkZpbGUiLCJtZXRhZGF0YSIsInRhZ3MiLCJmaWxlRGF0YSIsInNldFRhZ3MiLCJzZXRNZXRhZGF0YSIsImZpbGVTaXplIiwiQnVmZmVyIiwiYnl0ZUxlbmd0aCIsImZpbGVPYmplY3QiLCJ0cmlnZ2VyUmVzdWx0IiwibWF5YmVSdW5GaWxlVHJpZ2dlciIsIlR5cGVzIiwiYmVmb3JlU2F2ZUZpbGUiLCJzYXZlUmVzdWx0IiwidXJsIiwibmFtZSIsIl9uYW1lIiwiYnVmZmVyRGF0YSIsImZyb20iLCJmaWxlT3B0aW9ucyIsIl9tZXRhZGF0YSIsImZpbGVUYWdzIiwiT2JqZWN0Iiwia2V5cyIsIl90YWdzIiwiYXNzaWduIiwiY3JlYXRlRmlsZVJlc3VsdCIsImNyZWF0ZUZpbGUiLCJfdXJsIiwicmVzb2x2ZSIsImFmdGVyU2F2ZUZpbGUiLCJsb2dnZXIiLCJyZXNvbHZlRXJyb3IiLCJhZGFwdGVyIiwiZ2V0RmlsZUxvY2F0aW9uIiwiYmVmb3JlRGVsZXRlRmlsZSIsImRlbGV0ZUZpbGUiLCJhZnRlckRlbGV0ZUZpbGUiLCJGSUxFX0RFTEVURV9FUlJPUiIsImdldE1ldGFkYXRhIl0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL1JvdXRlcnMvRmlsZXNSb3V0ZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgQm9keVBhcnNlciBmcm9tICdib2R5LXBhcnNlcic7XG5pbXBvcnQgKiBhcyBNaWRkbGV3YXJlcyBmcm9tICcuLi9taWRkbGV3YXJlcyc7XG5pbXBvcnQgUGFyc2UgZnJvbSAncGFyc2Uvbm9kZSc7XG5pbXBvcnQgQ29uZmlnIGZyb20gJy4uL0NvbmZpZyc7XG5pbXBvcnQgbWltZSBmcm9tICdtaW1lJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IEZ1bmN0aW9uc1JvdXRlciB9IGZyb20gJy4vRnVuY3Rpb25zUm91dGVyJztcblxuY29uc3QgdHJpZ2dlcnMgPSByZXF1aXJlKCcuLi90cmlnZ2VycycpO1xuY29uc3QgaHR0cCA9IHJlcXVpcmUoJ2h0dHAnKTtcblxuY29uc3QgZG93bmxvYWRGaWxlRnJvbVVSSSA9IHVyaSA9PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzLCByZWopID0+IHtcbiAgICBodHRwXG4gICAgICAuZ2V0KHVyaSwgcmVzcG9uc2UgPT4ge1xuICAgICAgICByZXNwb25zZS5zZXREZWZhdWx0RW5jb2RpbmcoJ2Jhc2U2NCcpO1xuICAgICAgICBsZXQgYm9keSA9IGBkYXRhOiR7cmVzcG9uc2UuaGVhZGVyc1snY29udGVudC10eXBlJ119O2Jhc2U2NCxgO1xuICAgICAgICByZXNwb25zZS5vbignZGF0YScsIGRhdGEgPT4gKGJvZHkgKz0gZGF0YSkpO1xuICAgICAgICByZXNwb25zZS5vbignZW5kJywgKCkgPT4gcmVzKGJvZHkpKTtcbiAgICAgIH0pXG4gICAgICAub24oJ2Vycm9yJywgZSA9PiB7XG4gICAgICAgIHJlaihgRXJyb3IgZG93bmxvYWRpbmcgZmlsZSBmcm9tICR7dXJpfTogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICB9KTtcbiAgfSk7XG59O1xuXG5jb25zdCBhZGRGaWxlRGF0YUlmTmVlZGVkID0gYXN5bmMgZmlsZSA9PiB7XG4gIGlmIChmaWxlLl9zb3VyY2UuZm9ybWF0ID09PSAndXJpJykge1xuICAgIGNvbnN0IGJhc2U2NCA9IGF3YWl0IGRvd25sb2FkRmlsZUZyb21VUkkoZmlsZS5fc291cmNlLnVyaSk7XG4gICAgZmlsZS5fcHJldmlvdXNTYXZlID0gZmlsZTtcbiAgICBmaWxlLl9kYXRhID0gYmFzZTY0O1xuICAgIGZpbGUuX3JlcXVlc3RUYXNrID0gbnVsbDtcbiAgfVxuICByZXR1cm4gZmlsZTtcbn07XG5cbmV4cG9ydCBjbGFzcyBGaWxlc1JvdXRlciB7XG4gIGV4cHJlc3NSb3V0ZXIoeyBtYXhVcGxvYWRTaXplID0gJzIwTWInIH0gPSB7fSkge1xuICAgIHZhciByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuICAgIHJvdXRlci5nZXQoJy9maWxlcy86YXBwSWQvOmZpbGVuYW1lJywgdGhpcy5nZXRIYW5kbGVyKTtcbiAgICByb3V0ZXIuZ2V0KCcvZmlsZXMvOmFwcElkL21ldGFkYXRhLzpmaWxlbmFtZScsIHRoaXMubWV0YWRhdGFIYW5kbGVyKTtcblxuICAgIHJvdXRlci5wb3N0KCcvZmlsZXMnLCBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcbiAgICAgIG5leHQobmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLklOVkFMSURfRklMRV9OQU1FLCAnRmlsZW5hbWUgbm90IHByb3ZpZGVkLicpKTtcbiAgICB9KTtcblxuICAgIHJvdXRlci5wb3N0KFxuICAgICAgJy9maWxlcy86ZmlsZW5hbWUnLFxuICAgICAgQm9keVBhcnNlci5yYXcoe1xuICAgICAgICB0eXBlOiAoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0sXG4gICAgICAgIGxpbWl0OiBtYXhVcGxvYWRTaXplLFxuICAgICAgfSksIC8vIEFsbG93IHVwbG9hZHMgd2l0aG91dCBDb250ZW50LVR5cGUsIG9yIHdpdGggYW55IENvbnRlbnQtVHlwZS5cbiAgICAgIE1pZGRsZXdhcmVzLmhhbmRsZVBhcnNlSGVhZGVycyxcbiAgICAgIHRoaXMuY3JlYXRlSGFuZGxlclxuICAgICk7XG5cbiAgICByb3V0ZXIuZGVsZXRlKFxuICAgICAgJy9maWxlcy86ZmlsZW5hbWUnLFxuICAgICAgTWlkZGxld2FyZXMuaGFuZGxlUGFyc2VIZWFkZXJzLFxuICAgICAgTWlkZGxld2FyZXMuZW5mb3JjZU1hc3RlcktleUFjY2VzcyxcbiAgICAgIHRoaXMuZGVsZXRlSGFuZGxlclxuICAgICk7XG5cbiAgICByb3V0ZXIucG9zdChcbiAgICAgICcvZmlsZXMvOmZpbGVuYW1lLzpmdW5jdGlvbk5hbWUnLFxuICAgICAgQm9keVBhcnNlci5yYXcoe1xuICAgICAgICB0eXBlOiAoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0sXG4gICAgICAgIGxpbWl0OiBtYXhVcGxvYWRTaXplLFxuICAgICAgfSksIC8vIEFsbG93IHVwbG9hZHMgd2l0aG91dCBDb250ZW50LVR5cGUsIG9yIHdpdGggYW55IENvbnRlbnQtVHlwZS5cbiAgICAgIE1pZGRsZXdhcmVzLmhhbmRsZVBhcnNlSGVhZGVycyxcbiAgICAgIHJlcSA9PiB7XG4gICAgICAgIHJlcS5wYXJhbXMuY2xhc3NOYW1lID0gJ0BGaWxlJztcbiAgICAgICAgcmV0dXJuIEZ1bmN0aW9uc1JvdXRlci5oYW5kbGVDbG91ZEZ1bmN0aW9uKHJlcSk7XG4gICAgICB9XG4gICAgKTtcbiAgICByZXR1cm4gcm91dGVyO1xuICB9XG5cbiAgZ2V0SGFuZGxlcihyZXEsIHJlcykge1xuICAgIGNvbnN0IGNvbmZpZyA9IENvbmZpZy5nZXQocmVxLnBhcmFtcy5hcHBJZCk7XG4gICAgaWYgKCFjb25maWcpIHtcbiAgICAgIHJlcy5zdGF0dXMoNDAzKTtcbiAgICAgIGNvbnN0IGVyciA9IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5PUEVSQVRJT05fRk9SQklEREVOLCAnSW52YWxpZCBhcHBsaWNhdGlvbiBJRC4nKTtcbiAgICAgIHJlcy5qc29uKHsgY29kZTogZXJyLmNvZGUsIGVycm9yOiBlcnIubWVzc2FnZSB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZmlsZXNDb250cm9sbGVyID0gY29uZmlnLmZpbGVzQ29udHJvbGxlcjtcbiAgICBjb25zdCBmaWxlbmFtZSA9IHJlcS5wYXJhbXMuZmlsZW5hbWU7XG4gICAgY29uc3QgY29udGVudFR5cGUgPSBtaW1lLmdldFR5cGUoZmlsZW5hbWUpO1xuICAgIGlmIChpc0ZpbGVTdHJlYW1hYmxlKHJlcSwgZmlsZXNDb250cm9sbGVyKSkge1xuICAgICAgZmlsZXNDb250cm9sbGVyLmhhbmRsZUZpbGVTdHJlYW0oY29uZmlnLCBmaWxlbmFtZSwgcmVxLCByZXMsIGNvbnRlbnRUeXBlKS5jYXRjaCgoKSA9PiB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDA0KTtcbiAgICAgICAgcmVzLnNldCgnQ29udGVudC1UeXBlJywgJ3RleHQvcGxhaW4nKTtcbiAgICAgICAgcmVzLmVuZCgnRmlsZSBub3QgZm91bmQuJyk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmlsZXNDb250cm9sbGVyXG4gICAgICAgIC5nZXRGaWxlRGF0YShjb25maWcsIGZpbGVuYW1lKVxuICAgICAgICAudGhlbihkYXRhID0+IHtcbiAgICAgICAgICByZXMuc3RhdHVzKDIwMCk7XG4gICAgICAgICAgcmVzLnNldCgnQ29udGVudC1UeXBlJywgY29udGVudFR5cGUpO1xuICAgICAgICAgIHJlcy5zZXQoJ0NvbnRlbnQtTGVuZ3RoJywgZGF0YS5sZW5ndGgpO1xuICAgICAgICAgIHJlcy5lbmQoZGF0YSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgoKSA9PiB7XG4gICAgICAgICAgcmVzLnN0YXR1cyg0MDQpO1xuICAgICAgICAgIHJlcy5zZXQoJ0NvbnRlbnQtVHlwZScsICd0ZXh0L3BsYWluJyk7XG4gICAgICAgICAgcmVzLmVuZCgnRmlsZSBub3QgZm91bmQuJyk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZUhhbmRsZXIocmVxLCByZXMsIG5leHQpIHtcbiAgICBjb25zdCBjb25maWcgPSByZXEuY29uZmlnO1xuICAgIGNvbnN0IHVzZXIgPSByZXEuYXV0aC51c2VyO1xuICAgIGNvbnN0IGlzTWFzdGVyID0gcmVxLmF1dGguaXNNYXN0ZXI7XG4gICAgY29uc3QgaXNMaW5rZWQgPSB1c2VyICYmIFBhcnNlLkFub255bW91c1V0aWxzLmlzTGlua2VkKHVzZXIpO1xuICAgIGlmICghaXNNYXN0ZXIgJiYgIWNvbmZpZy5maWxlVXBsb2FkLmVuYWJsZUZvckFub255bW91c1VzZXIgJiYgaXNMaW5rZWQpIHtcbiAgICAgIG5leHQoXG4gICAgICAgIG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5GSUxFX1NBVkVfRVJST1IsICdGaWxlIHVwbG9hZCBieSBhbm9ueW1vdXMgdXNlciBpcyBkaXNhYmxlZC4nKVxuICAgICAgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCFpc01hc3RlciAmJiAhY29uZmlnLmZpbGVVcGxvYWQuZW5hYmxlRm9yQXV0aGVudGljYXRlZFVzZXIgJiYgIWlzTGlua2VkICYmIHVzZXIpIHtcbiAgICAgIG5leHQoXG4gICAgICAgIG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgICBQYXJzZS5FcnJvci5GSUxFX1NBVkVfRVJST1IsXG4gICAgICAgICAgJ0ZpbGUgdXBsb2FkIGJ5IGF1dGhlbnRpY2F0ZWQgdXNlciBpcyBkaXNhYmxlZC4nXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghaXNNYXN0ZXIgJiYgIWNvbmZpZy5maWxlVXBsb2FkLmVuYWJsZUZvclB1YmxpYyAmJiAhdXNlcikge1xuICAgICAgbmV4dChuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuRklMRV9TQVZFX0VSUk9SLCAnRmlsZSB1cGxvYWQgYnkgcHVibGljIGlzIGRpc2FibGVkLicpKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZmlsZXNDb250cm9sbGVyID0gY29uZmlnLmZpbGVzQ29udHJvbGxlcjtcbiAgICBjb25zdCB7IGZpbGVuYW1lIH0gPSByZXEucGFyYW1zO1xuICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gcmVxLmdldCgnQ29udGVudC10eXBlJyk7XG5cbiAgICBpZiAoIXJlcS5ib2R5IHx8ICFyZXEuYm9keS5sZW5ndGgpIHtcbiAgICAgIG5leHQobmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLkZJTEVfU0FWRV9FUlJPUiwgJ0ludmFsaWQgZmlsZSB1cGxvYWQuJykpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGVycm9yID0gZmlsZXNDb250cm9sbGVyLnZhbGlkYXRlRmlsZW5hbWUoZmlsZW5hbWUpO1xuICAgIGlmIChlcnJvcikge1xuICAgICAgbmV4dChlcnJvcik7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgYmFzZTY0ID0gcmVxLmJvZHkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICAgIGNvbnN0IGZpbGUgPSBuZXcgUGFyc2UuRmlsZShmaWxlbmFtZSwgeyBiYXNlNjQgfSwgY29udGVudFR5cGUpO1xuICAgIGNvbnN0IHsgbWV0YWRhdGEgPSB7fSwgdGFncyA9IHt9IH0gPSByZXEuZmlsZURhdGEgfHwge307XG4gICAgZmlsZS5zZXRUYWdzKHRhZ3MpO1xuICAgIGZpbGUuc2V0TWV0YWRhdGEobWV0YWRhdGEpO1xuICAgIGNvbnN0IGZpbGVTaXplID0gQnVmZmVyLmJ5dGVMZW5ndGgocmVxLmJvZHkpO1xuICAgIGNvbnN0IGZpbGVPYmplY3QgPSB7IGZpbGUsIGZpbGVTaXplIH07XG4gICAgdHJ5IHtcbiAgICAgIC8vIHJ1biBiZWZvcmVTYXZlRmlsZSB0cmlnZ2VyXG4gICAgICBjb25zdCB0cmlnZ2VyUmVzdWx0ID0gYXdhaXQgdHJpZ2dlcnMubWF5YmVSdW5GaWxlVHJpZ2dlcihcbiAgICAgICAgdHJpZ2dlcnMuVHlwZXMuYmVmb3JlU2F2ZUZpbGUsXG4gICAgICAgIGZpbGVPYmplY3QsXG4gICAgICAgIGNvbmZpZyxcbiAgICAgICAgcmVxLmF1dGhcbiAgICAgICk7XG4gICAgICBsZXQgc2F2ZVJlc3VsdDtcbiAgICAgIC8vIGlmIGEgbmV3IFBhcnNlRmlsZSBpcyByZXR1cm5lZCBjaGVjayBpZiBpdCdzIGFuIGFscmVhZHkgc2F2ZWQgZmlsZVxuICAgICAgaWYgKHRyaWdnZXJSZXN1bHQgaW5zdGFuY2VvZiBQYXJzZS5GaWxlKSB7XG4gICAgICAgIGZpbGVPYmplY3QuZmlsZSA9IHRyaWdnZXJSZXN1bHQ7XG4gICAgICAgIGlmICh0cmlnZ2VyUmVzdWx0LnVybCgpKSB7XG4gICAgICAgICAgLy8gc2V0IGZpbGVTaXplIHRvIG51bGwgYmVjYXVzZSB3ZSB3b250IGtub3cgaG93IGJpZyBpdCBpcyBoZXJlXG4gICAgICAgICAgZmlsZU9iamVjdC5maWxlU2l6ZSA9IG51bGw7XG4gICAgICAgICAgc2F2ZVJlc3VsdCA9IHtcbiAgICAgICAgICAgIHVybDogdHJpZ2dlclJlc3VsdC51cmwoKSxcbiAgICAgICAgICAgIG5hbWU6IHRyaWdnZXJSZXN1bHQuX25hbWUsXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy8gaWYgdGhlIGZpbGUgcmV0dXJuZWQgYnkgdGhlIHRyaWdnZXIgaGFzIGFscmVhZHkgYmVlbiBzYXZlZCBza2lwIHNhdmluZyBhbnl0aGluZ1xuICAgICAgaWYgKCFzYXZlUmVzdWx0KSB7XG4gICAgICAgIC8vIGlmIHRoZSBQYXJzZUZpbGUgcmV0dXJuZWQgaXMgdHlwZSB1cmksIGRvd25sb2FkIHRoZSBmaWxlIGJlZm9yZSBzYXZpbmcgaXRcbiAgICAgICAgYXdhaXQgYWRkRmlsZURhdGFJZk5lZWRlZChmaWxlT2JqZWN0LmZpbGUpO1xuICAgICAgICAvLyB1cGRhdGUgZmlsZVNpemVcbiAgICAgICAgY29uc3QgYnVmZmVyRGF0YSA9IEJ1ZmZlci5mcm9tKGZpbGVPYmplY3QuZmlsZS5fZGF0YSwgJ2Jhc2U2NCcpO1xuICAgICAgICBmaWxlT2JqZWN0LmZpbGVTaXplID0gQnVmZmVyLmJ5dGVMZW5ndGgoYnVmZmVyRGF0YSk7XG4gICAgICAgIC8vIHByZXBhcmUgZmlsZSBvcHRpb25zXG4gICAgICAgIGNvbnN0IGZpbGVPcHRpb25zID0ge1xuICAgICAgICAgIG1ldGFkYXRhOiBmaWxlT2JqZWN0LmZpbGUuX21ldGFkYXRhLFxuICAgICAgICB9O1xuICAgICAgICAvLyBzb21lIHMzLWNvbXBhdGlibGUgcHJvdmlkZXJzIChEaWdpdGFsT2NlYW4sIExpbm9kZSkgZG8gbm90IGFjY2VwdCB0YWdzXG4gICAgICAgIC8vIHNvIHdlIGRvIG5vdCBpbmNsdWRlIHRoZSB0YWdzIG9wdGlvbiBpZiBpdCBpcyBlbXB0eS5cbiAgICAgICAgY29uc3QgZmlsZVRhZ3MgPVxuICAgICAgICAgIE9iamVjdC5rZXlzKGZpbGVPYmplY3QuZmlsZS5fdGFncykubGVuZ3RoID4gMCA/IHsgdGFnczogZmlsZU9iamVjdC5maWxlLl90YWdzIH0gOiB7fTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihmaWxlT3B0aW9ucywgZmlsZVRhZ3MpO1xuICAgICAgICAvLyBzYXZlIGZpbGVcbiAgICAgICAgY29uc3QgY3JlYXRlRmlsZVJlc3VsdCA9IGF3YWl0IGZpbGVzQ29udHJvbGxlci5jcmVhdGVGaWxlKFxuICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICBmaWxlT2JqZWN0LmZpbGUuX25hbWUsXG4gICAgICAgICAgYnVmZmVyRGF0YSxcbiAgICAgICAgICBmaWxlT2JqZWN0LmZpbGUuX3NvdXJjZS50eXBlLFxuICAgICAgICAgIGZpbGVPcHRpb25zXG4gICAgICAgICk7XG4gICAgICAgIC8vIHVwZGF0ZSBmaWxlIHdpdGggbmV3IGRhdGFcbiAgICAgICAgZmlsZU9iamVjdC5maWxlLl9uYW1lID0gY3JlYXRlRmlsZVJlc3VsdC5uYW1lO1xuICAgICAgICBmaWxlT2JqZWN0LmZpbGUuX3VybCA9IGNyZWF0ZUZpbGVSZXN1bHQudXJsO1xuICAgICAgICBmaWxlT2JqZWN0LmZpbGUuX3JlcXVlc3RUYXNrID0gbnVsbDtcbiAgICAgICAgZmlsZU9iamVjdC5maWxlLl9wcmV2aW91c1NhdmUgPSBQcm9taXNlLnJlc29sdmUoZmlsZU9iamVjdC5maWxlKTtcbiAgICAgICAgc2F2ZVJlc3VsdCA9IHtcbiAgICAgICAgICB1cmw6IGNyZWF0ZUZpbGVSZXN1bHQudXJsLFxuICAgICAgICAgIG5hbWU6IGNyZWF0ZUZpbGVSZXN1bHQubmFtZSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIC8vIHJ1biBhZnRlclNhdmVGaWxlIHRyaWdnZXJcbiAgICAgIGF3YWl0IHRyaWdnZXJzLm1heWJlUnVuRmlsZVRyaWdnZXIoXG4gICAgICAgIHRyaWdnZXJzLlR5cGVzLmFmdGVyU2F2ZUZpbGUsXG4gICAgICAgIGZpbGVPYmplY3QsXG4gICAgICAgIGNvbmZpZyxcbiAgICAgICAgcmVxLmF1dGhcbiAgICAgICk7XG4gICAgICByZXMuc3RhdHVzKDIwMSk7XG4gICAgICByZXMuc2V0KCdMb2NhdGlvbicsIHNhdmVSZXN1bHQudXJsKTtcbiAgICAgIHJlcy5qc29uKHNhdmVSZXN1bHQpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgY3JlYXRpbmcgYSBmaWxlOiAnLCBlKTtcbiAgICAgIGNvbnN0IGVycm9yID0gdHJpZ2dlcnMucmVzb2x2ZUVycm9yKGUsIHtcbiAgICAgICAgY29kZTogUGFyc2UuRXJyb3IuRklMRV9TQVZFX0VSUk9SLFxuICAgICAgICBtZXNzYWdlOiBgQ291bGQgbm90IHN0b3JlIGZpbGU6ICR7ZmlsZU9iamVjdC5maWxlLl9uYW1lfS5gLFxuICAgICAgfSk7XG4gICAgICBuZXh0KGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkZWxldGVIYW5kbGVyKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZmlsZXNDb250cm9sbGVyIH0gPSByZXEuY29uZmlnO1xuICAgICAgY29uc3QgeyBmaWxlbmFtZSB9ID0gcmVxLnBhcmFtcztcbiAgICAgIC8vIHJ1biBiZWZvcmVEZWxldGVGaWxlIHRyaWdnZXJcbiAgICAgIGNvbnN0IGZpbGUgPSBuZXcgUGFyc2UuRmlsZShmaWxlbmFtZSk7XG4gICAgICBmaWxlLl91cmwgPSBmaWxlc0NvbnRyb2xsZXIuYWRhcHRlci5nZXRGaWxlTG9jYXRpb24ocmVxLmNvbmZpZywgZmlsZW5hbWUpO1xuICAgICAgY29uc3QgZmlsZU9iamVjdCA9IHsgZmlsZSwgZmlsZVNpemU6IG51bGwgfTtcbiAgICAgIGF3YWl0IHRyaWdnZXJzLm1heWJlUnVuRmlsZVRyaWdnZXIoXG4gICAgICAgIHRyaWdnZXJzLlR5cGVzLmJlZm9yZURlbGV0ZUZpbGUsXG4gICAgICAgIGZpbGVPYmplY3QsXG4gICAgICAgIHJlcS5jb25maWcsXG4gICAgICAgIHJlcS5hdXRoXG4gICAgICApO1xuICAgICAgLy8gZGVsZXRlIGZpbGVcbiAgICAgIGF3YWl0IGZpbGVzQ29udHJvbGxlci5kZWxldGVGaWxlKHJlcS5jb25maWcsIGZpbGVuYW1lKTtcbiAgICAgIC8vIHJ1biBhZnRlckRlbGV0ZUZpbGUgdHJpZ2dlclxuICAgICAgYXdhaXQgdHJpZ2dlcnMubWF5YmVSdW5GaWxlVHJpZ2dlcihcbiAgICAgICAgdHJpZ2dlcnMuVHlwZXMuYWZ0ZXJEZWxldGVGaWxlLFxuICAgICAgICBmaWxlT2JqZWN0LFxuICAgICAgICByZXEuY29uZmlnLFxuICAgICAgICByZXEuYXV0aFxuICAgICAgKTtcbiAgICAgIHJlcy5zdGF0dXMoMjAwKTtcbiAgICAgIC8vIFRPRE86IHJldHVybiB1c2VmdWwgSlNPTiBoZXJlP1xuICAgICAgcmVzLmVuZCgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgZGVsZXRpbmcgYSBmaWxlOiAnLCBlKTtcbiAgICAgIGNvbnN0IGVycm9yID0gdHJpZ2dlcnMucmVzb2x2ZUVycm9yKGUsIHtcbiAgICAgICAgY29kZTogUGFyc2UuRXJyb3IuRklMRV9ERUxFVEVfRVJST1IsXG4gICAgICAgIG1lc3NhZ2U6ICdDb3VsZCBub3QgZGVsZXRlIGZpbGUuJyxcbiAgICAgIH0pO1xuICAgICAgbmV4dChlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbWV0YWRhdGFIYW5kbGVyKHJlcSwgcmVzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNvbmZpZyA9IENvbmZpZy5nZXQocmVxLnBhcmFtcy5hcHBJZCk7XG4gICAgICBjb25zdCB7IGZpbGVzQ29udHJvbGxlciB9ID0gY29uZmlnO1xuICAgICAgY29uc3QgeyBmaWxlbmFtZSB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBmaWxlc0NvbnRyb2xsZXIuZ2V0TWV0YWRhdGEoZmlsZW5hbWUpO1xuICAgICAgcmVzLnN0YXR1cygyMDApO1xuICAgICAgcmVzLmpzb24oZGF0YSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcmVzLnN0YXR1cygyMDApO1xuICAgICAgcmVzLmpzb24oe30pO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBpc0ZpbGVTdHJlYW1hYmxlKHJlcSwgZmlsZXNDb250cm9sbGVyKSB7XG4gIHJldHVybiByZXEuZ2V0KCdSYW5nZScpICYmIHR5cGVvZiBmaWxlc0NvbnRyb2xsZXIuYWRhcHRlci5oYW5kbGVGaWxlU3RyZWFtID09PSAnZnVuY3Rpb24nO1xufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBRUEsTUFBTUEsUUFBUSxHQUFHQyxPQUFPLENBQUMsYUFBRCxDQUF4Qjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUVBLE1BQU1FLG1CQUFtQixHQUFHQyxHQUFHLElBQUk7RUFDakMsT0FBTyxJQUFJQyxPQUFKLENBQVksQ0FBQ0MsR0FBRCxFQUFNQyxHQUFOLEtBQWM7SUFDL0JMLElBQUksQ0FDRE0sR0FESCxDQUNPSixHQURQLEVBQ1lLLFFBQVEsSUFBSTtNQUNwQkEsUUFBUSxDQUFDQyxrQkFBVCxDQUE0QixRQUE1QjtNQUNBLElBQUlDLElBQUksR0FBSSxRQUFPRixRQUFRLENBQUNHLE9BQVQsQ0FBaUIsY0FBakIsQ0FBaUMsVUFBcEQ7TUFDQUgsUUFBUSxDQUFDSSxFQUFULENBQVksTUFBWixFQUFvQkMsSUFBSSxJQUFLSCxJ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